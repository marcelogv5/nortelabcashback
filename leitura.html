<script>
  let dados = {};
  try {
    const paramEncoded = new URLSearchParams(window.location.search).get("d");
    if (!paramEncoded) throw new Error("Parâmetro 'd' não encontrado na URL");

    const params = new URLSearchParams(atob(paramEncoded));
    for (const [key, value] of params.entries()) {
      dados[key] = value;
    }

    document.getElementById("nome").innerText = dados.nome;
    document.getElementById("req").innerText = dados.req;
    document.getElementById("itens").innerText = dados.itens;
    document.getElementById("usado").innerText = parseFloat(dados.usado).toFixed(2).replace(".", ",");
    document.getElementById("sobra").innerText = parseFloat(dados.sobra).toFixed(2).replace(".", ",");

  } catch (err) {
    document.body.innerHTML = "<div style='text-align:center;padding:40px;color:red;'><h2>Erro ao carregar dados do QR Code</h2><p>" + err.message + "</p></div>";
    console.error("Erro ao decodificar dados:", err);
  }

  function confirmarEntrega() {
    const payload = {
      nome: dados.nome || "",
      req: dados.req || "",
      itens: dados.itens || "",
      usado: parseFloat(dados.usado || 0),
      sobra: parseFloat(dados.sobra || 0)
    };

    console.log("Enviando para Google Script:", payload);

    fetch("https://script.google.com/macros/s/AKfycbynLSiRnLR6KXI9VeWXvi-1P4ktZDuMcAlZmMunpilN0dlnKh7eaaRwAyvEFWI7fdM/exec", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify(payload)
    })
    .then(res => res.text())
    .then(msg => {
      console.log("Resposta:", msg);
      document.getElementById("resposta").innerText = "Cortesia entregue ao paciente!";
      document.getElementById("confirmar").disabled = true;
    })
    .catch(err => {
      console.error("Erro ao registrar entrega:", err);
      document.getElementById("resposta").innerText = "Erro ao registrar entrega.";
    });
  }
</script>
